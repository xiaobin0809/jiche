<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>机车千分榜</title>
<style>
body { margin:0; overflow:hidden; background:#0f0f0f; font-family:Arial, sans-serif; }

/* 后圆柱小卡片 */
.card { width:55px;height:60px;background:linear-gradient(145deg,#1c1c1c,#2a2a2a);border-radius:8px;
box-shadow:0 5px 6px rgba(0,0,0,0.55),0 0 4px rgba(255,204,85,0.6);
display:flex;flex-direction:column;align-items:center;padding-top:2px;font-size:7px;color:#fff;}
.avatar{width:38px;height:38px;border-radius:50%;overflow:hidden;display:flex;justify-content:center;align-items:center;}
.avatar img{width:auto;height:110%;object-fit:cover;}
.badge{width:24px;height:12px;margin-top:-8px;margin-bottom:1px;}
.nickname{text-align:center;font-weight:600;font-size:12px;text-shadow:0 0 1px rgba(255,204,85,0.7);
overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;line-height:1.2;padding:0 2px;}

/* 前屏大卡片 */
.card1{width:180px;height:200px;display:flex;flex-direction:column;align-items:center;padding-top:50px;
font-size:14px;color:#fff;background:rgba(28,28,28,0.2);border-radius:12px;
box-shadow:0 10px 25px rgba(0,0,0,0.4),0 0 10px rgba(255,204,85,0.4);transform-style: preserve-3d;}
.avatar1{width:120px;height:120px;border-radius:50%;overflow:hidden;display:flex;justify-content:center;align-items:center;
box-shadow:0 0 15px rgba(255,204,85,0.6);}
.avatar1 img{width:auto;height:100%;object-fit:cover;}
.badge1{width:60px;height:30px;margin-top:-20px;margin-bottom:15px;transform: translateZ(5px);}
.nickname1{text-align:center;font-weight:600;font-size:30px;text-shadow:0 0 8px rgba(255,204,85,0.9);
overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;line-height:1.2;padding:0 5px;transform: translateZ(12px);}

/* 水印 */
#watermark{position:absolute;top:20px;left:50%;transform:translateX(-50%) rotateX(5deg);
font-size:70px;font-weight:800;font-family:"Arial","微软雅黑",sans-serif;
color:rgba(255,204,85,0.5);
text-shadow:0 0 10px rgba(255,204,85,0.15),0 0 20px rgba(255,204,85,0.1),0 0 30px rgba(255,204,85,0.05);
pointer-events:none;z-index:0;white-space:nowrap;}
</style>
</head>
<body>

<div id="watermark">千分榜</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS3DRenderer.js"></script>

<script>
fetch("output.json").then(r=>r.json()).then(data=>{
document.getElementById("watermark").textContent = `12月3号南极公会赛决赛 ${data.length} 位千分榜`;

const CARD_WIDTH=50, CARD_HEIGHT=55, CARDS_PER_FRONT=55;
const CYLINDER_RADIUS=700, CYLINDER_LAYER_HEIGHT=70;
const FRONT_RADIUS=1900, FRONT_ANGLE_STEP=0.55, VISIBLE_COUNT=20;
const FRONT_SPACING = 220;
const FRONT_SPEED = 0.7;
const ROT_SPEED=0.0005, FADE_DIST=150;

const sceneCyl = new THREE.Scene();
const sceneFront = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 5000);
camera.position.z = 800;

const rendererCyl = new THREE.CSS3DRenderer();
rendererCyl.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(rendererCyl.domElement);

const rendererFront = new THREE.CSS3DRenderer();
rendererFront.setSize(window.innerWidth, window.innerHeight);
rendererFront.domElement.style.position='absolute';
rendererFront.domElement.style.top='0';
rendererFront.domElement.style.left='0';
rendererFront.domElement.style.pointerEvents='none';
document.body.appendChild(rendererFront.domElement);

const controls = new THREE.OrbitControls(camera, rendererCyl.domElement);
controls.enablePan=false; controls.enableZoom=false;

// 后圆柱
const cylinderObjs=[];
const levels=Math.ceil(data.length/CARDS_PER_FRONT);
data.forEach((item,index)=>{
    const phi = 2*Math.PI*(index%CARDS_PER_FRONT)/CARDS_PER_FRONT;
    const level = Math.floor(index/CARDS_PER_FRONT);
    const theta = - (levels/2)*CYLINDER_LAYER_HEIGHT + level*CYLINDER_LAYER_HEIGHT;

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<div class="avatar"><img src="${item.avatar_url}"/></div>
                   <img class="badge" src="${item.badge_url}"/>
                   <div class="nickname">${item.nick_name}</div>`;
    const obj=new THREE.CSS3DObject(div);
    obj.position.x = CYLINDER_RADIUS*Math.cos(phi);
    obj.position.y = theta;
    obj.position.z = CYLINDER_RADIUS*Math.sin(phi);
    obj.userData={phi,theta,radius:CYLINDER_RADIUS};
    obj.userData.originalPos=obj.position.clone();
    sceneCyl.add(obj);
    cylinderObjs.push(obj);
});

// 前屏初始化并填充数据
const frontObjs=[];
for(let i=0;i<VISIBLE_COUNT;i++){
    const div=document.createElement("div");
    div.className="card1";
    div.innerHTML=`<div class="avatar1"><img src=""/></div>
                   <img class="badge1" src=""/>
                   <div class="nickname1"></div>`;
    const obj=new THREE.CSS3DObject(div);
    obj.dataIndex = i % data.length;
    obj.position.x = i*FRONT_SPACING;

    const item = data[obj.dataIndex];
    obj.element.querySelector(".avatar1 img").src = item.avatar_url;
    obj.element.querySelector(".badge1").src = item.badge_url;
    obj.element.querySelector(".nickname1").textContent = item.nick_name;

    sceneFront.add(obj);
    frontObjs.push(obj);
}

function animate(){
    requestAnimationFrame(animate);
    const time = Date.now()*0.001;

    // 后圆柱旋转+浮动
    cylinderObjs.forEach(obj=>{
        const angle = obj.userData.phi + time*ROT_SPEED*100;
        obj.position.x = obj.userData.radius*Math.cos(angle);
        obj.position.z = obj.userData.radius*Math.sin(angle);
        obj.position.y = obj.userData.theta + Math.sin(time+obj.userData.phi)*3;
        obj.lookAt(camera.position);

        const dz=obj.position.z;
        if(dz>0){ obj.visible=false; }
        else if(dz>-FADE_DIST){ obj.visible=true; obj.element.style.opacity=1+dz/FADE_DIST; }
        else{ obj.visible=true; obj.element.style.opacity=1; }
    });

    // 前屏平滑弧度循环
    frontObjs.forEach(obj=>{
        obj.position.x -= FRONT_SPEED;
        if(obj.position.x < -FRONT_SPACING){
            obj.position.x += VISIBLE_COUNT * FRONT_SPACING;
            obj.dataIndex = (obj.dataIndex + VISIBLE_COUNT) % data.length;
            const item = data[obj.dataIndex];
            obj.element.querySelector(".avatar1 img").src = item.avatar_url;
            obj.element.querySelector(".badge1").src = item.badge_url;
            obj.element.querySelector(".nickname1").textContent = item.nick_name;
        }

        // 弧度计算
        const angle = (obj.position.x - (VISIBLE_COUNT/2)*FRONT_SPACING)/FRONT_RADIUS;
        obj.rotation.y = angle * FRONT_ANGLE_STEP * 20;
        obj.position.z = FRONT_RADIUS * (1 - Math.cos(angle * FRONT_ANGLE_STEP));
        obj.scale.setScalar(1 - obj.position.z/2500);
        obj.element.style.opacity = Math.max(0, Math.min(1, 1 - obj.position.z/2500));
    });

    rendererCyl.render(sceneCyl,camera);
    rendererFront.render(sceneFront,camera);
}
animate();

window.addEventListener("resize",()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    rendererCyl.setSize(window.innerWidth, window.innerHeight);
    rendererFront.setSize(window.innerWidth, window.innerHeight);
});
});
</script>
</body>
</html>
